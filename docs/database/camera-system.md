# Camera System Detailed Documentation

## Overview
Three-table system designed for seasonal camera management with missing detection and smart alerts.

## Architecture

```
camera_hardware
├── Physical devices (brand, model, serial)
├── Device IDs from reports ("002", "013")
└── Condition tracking

camera_deployments
├── Current locations and seasons
├── Solar panel configuration
├── Missing detection fields
└── Links to nearby stands

camera_status_reports
├── Daily report data
├── Automatic alert generation
└── Historical tracking
```

## Missing Camera Detection Logic

### Daily Processing Workflow
1. **Report Collection**: Process daily email reports from cameras
2. **Status Update**: Insert/update camera_status_reports
3. **Missing Detection**: Run `detect_missing_cameras()` function
4. **Alert Generation**: Update deployment status and create alerts

### Missing Detection Fields

**last_seen_date**: Last date this camera appeared in any report
- Updated by `detect_missing_cameras()` function
- Used to track when cameras go offline

**missing_since_date**: First date camera was noticed missing
- Set when camera first detected as missing
- Cleared when camera reports again

**is_missing**: Boolean flag for currently missing cameras
- `true` = Camera hasn't reported recently
- `false` = Camera is reporting normally

**consecutive_missing_days**: Days missing in a row
- Incremented daily while missing
- Reset to 0 when camera reports again
- Used for escalating alerts

### Detection Function
```sql
SELECT detect_missing_cameras(CURRENT_DATE);
```

**Logic:**
1. Loop through all active deployments
2. Find latest report date for each camera
3. Compare against check_date (usually today)
4. Update missing status accordingly

**Returns:** Number of cameras detected as missing

## Alert System

### Automatic Alert Triggers

**Battery Alerts:**
- `battery_status = 'Low'` → Immediate alert
- Solar cameras showing `'OK'` instead of `'Ext OK'` → Solar panel issue

**Storage Alerts:**
- `sd_free_space_mb < 500` → Low storage warning

**Connectivity Alerts:**
- `signal_level` contains 'Poor' → Poor signal warning
- `image_queue > 20` → Upload backlog alert

**Missing Camera Alerts:**
- Generated by daily missing detection function
- Priority: Missing > Battery > Storage > Connectivity

### Alert Fields

**needs_attention**: Boolean flag set by trigger
**alert_reason**: Human-readable description of issues

## Seasonal Management

### Deployment Workflow
1. **End of Season**: Mark deployment as `active = false`
2. **Camera Retrieval**: Update hardware condition and notes
3. **New Season**: Create new deployment record
4. **Same Location**: Link to previous season's coordinates

### Benefits
- Historical tracking of camera locations
- Ability to reuse optimal locations
- Seasonal performance analysis
- Equipment rotation tracking

## Solar Panel Management

### Configuration
- `has_solar_panel` flag in deployments table
- Critical for battery alert logic

### Alert Logic
- **Solar cameras**: Should report `battery_status = 'Ext OK'`
- **Battery cameras**: Should report `battery_status = 'OK'`
- **Issue detection**: Solar camera showing 'OK' = panel problem

## Data Relationships

### Hardware → Deployments (One-to-Many)
- One camera device can have multiple deployments over time
- Tracks seasonal moves and location changes
- Preserves hardware investment tracking

### Deployments → Reports (One-to-Many)
- Each deployment generates daily status reports
- Historical performance data
- Alert and issue tracking

### Stands Integration (Optional)
- Deployments can link to nearby hunting stands
- Helps with camera placement strategy
- Cross-references hunting activity with camera data

## Performance Considerations

### Indexes
- `idx_camera_deployments_missing` - Fast missing camera queries
- `idx_camera_reports_alerts` - Dashboard alert summaries
- `idx_camera_reports_date` - Date-based queries
- `idx_camera_deployments_last_seen` - Missing detection performance

### Query Patterns
- **Dashboard alerts**: Filter by `needs_attention = true`
- **Missing cameras**: Filter by `is_missing = true`
- **Daily reports**: Order by `report_date DESC`
- **Seasonal analysis**: Group by `season_year`

## Common Queries

### Find All Missing Cameras
```sql
SELECT 
  ch.device_id,
  cd.location_name,
  cd.missing_since_date,
  cd.consecutive_missing_days
FROM camera_deployments cd
JOIN camera_hardware ch ON cd.hardware_id = ch.id
WHERE cd.is_missing = true
AND cd.active = true
ORDER BY cd.consecutive_missing_days DESC;
```

### Daily Alert Summary
```sql
SELECT 
  ch.device_id,
  cd.location_name,
  csr.alert_reason,
  csr.report_date
FROM camera_status_reports csr
JOIN camera_deployments cd ON csr.deployment_id = cd.id
JOIN camera_hardware ch ON cd.hardware_id = ch.id
WHERE csr.needs_attention = true
AND csr.report_date = CURRENT_DATE
ORDER BY ch.device_id;
```

### Camera Performance by Season
```sql
SELECT 
  cd.season_year,
  ch.device_id,
  cd.location_name,
  COUNT(csr.id) as total_reports,
  COUNT(CASE WHEN csr.needs_attention THEN 1 END) as alert_count
FROM camera_deployments cd
JOIN camera_hardware ch ON cd.hardware_id = ch.id
LEFT JOIN camera_status_reports csr ON cd.id = csr.deployment_id
GROUP BY cd.season_year, ch.device_id, cd.location_name
ORDER BY cd.season_year DESC, ch.device_id;
```

## Maintenance Procedures

### Daily Tasks
1. Process email reports → Insert status records
2. Run missing detection → `SELECT detect_missing_cameras();`
3. Review alerts → Check `needs_attention = true` records
4. Investigate missing cameras → `consecutive_missing_days > 1`

### Seasonal Tasks
1. **End of Season**: Deactivate deployments, update hardware condition
2. **Start of Season**: Create new deployments, verify hardware status
3. **Mid-Season**: Review performance, relocate underperforming cameras

### Data Cleanup
- Backup table `trail_cameras_backup` can be dropped after 7 days
- Old status reports archived after 2 years
- Inactive deployments preserved for historical analysis